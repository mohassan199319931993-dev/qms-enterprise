<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defect Records — QMS Enterprise</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/enterprise.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="enterprise-body">
<div class="app-layout">
  <aside class="sidebar enterprise-sidebar" id="appSidebar"></aside>
  <main class="main-content">
    <header class="topbar">
      <div class="topbar-title"><span id="topbarTitle"></span></div>
      <div class="topbar-actions">
        <input type="date" id="filterDate" class="form-input" style="width:140px" onchange="loadDefects()">
        <select id="filterMachine" class="form-input" style="width:150px" onchange="loadDefects()">
          <option value="">All Machines</option>
        </select>
        <button class="btn-primary" onclick="openAddDefect()"><i class="fas fa-plus"></i> Log Defect</button>
        <span id="topbarFactory" class="badge badge-primary"></span>
      </div>
    </header>
    <div class="page-content">

      <!-- Summary KPIs -->
      <div class="kpi-row">
        <div class="kpi-card kpi-ppm"><div class="kpi-label">Total Records</div><div class="kpi-value" id="kTotal">—</div><div class="kpi-sub">This period</div></div>
        <div class="kpi-card kpi-dr"><div class="kpi-label">Total Defective</div><div class="kpi-value" id="kDefective">—</div><div class="kpi-sub">Units</div></div>
        <div class="kpi-card kpi-oee"><div class="kpi-label">PPM</div><div class="kpi-value" id="kPPM">—</div><div class="kpi-sub">Parts Per Million</div></div>
        <div class="kpi-card kpi-fpy"><div class="kpi-label">FPY</div><div class="kpi-value" id="kFPY">—</div><div class="kpi-sub">First Pass Yield</div></div>
      </div>

      <!-- RCA Quick Query -->
      <div class="chart-card" style="padding:1rem">
        <div style="display:flex;gap:.75rem;align-items:flex-end">
          <div style="flex:1">
            <label style="font-size:.7rem;color:var(--text-muted);display:block;margin-bottom:.3rem">RCA — ROOT CAUSE ANALYSIS</label>
            <div style="display:flex;gap:.5rem">
              <input id="rcaCode" class="form-input" placeholder="Defect code e.g. D-101" style="flex:1">
              <button class="btn-sm" onclick="runRCA()"><i class="fas fa-brain"></i> Analyze Root Cause</button>
            </div>
          </div>
          <div id="rcaResult" style="flex:2;font-size:.82rem;color:var(--text-muted);padding:.5rem">Enter a defect code and click Analyze</div>
        </div>
      </div>

      <!-- Defect Records Table -->
      <div class="chart-card">
        <div class="chart-card-header">
          <h3>Defect Records</h3>
          <span id="recordCount" class="badge badge-primary">—</span>
        </div>
        <div id="defectTable" style="overflow-x:auto;padding:.5rem 0 1rem"></div>
      </div>

    </div>
  </main>
</div>

<!-- Add Defect Modal -->
<div id="defectModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" style="width:500px">
    <div class="modal-header"><h3>Log Defect Record</h3><button onclick="closeModal()" class="btn-sm"><i class="fas fa-times"></i></button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
        <div>
          <label>Date *</label>
          <input id="dDate" type="date" class="form-input">
        </div>
        <div>
          <label>Shift</label>
          <select id="dShift" class="form-input">
            <option value="morning">Morning</option>
            <option value="afternoon">Afternoon</option>
            <option value="night">Night</option>
          </select>
        </div>
        <div>
          <label>Machine</label>
          <select id="dMachine" class="form-input"><option value="">Select...</option></select>
        </div>
        <div>
          <label>Defect Code</label>
          <select id="dCode" class="form-input"><option value="">Select...</option></select>
        </div>
        <div>
          <label>Qty Produced *</label>
          <input id="dProduced" type="number" class="form-input" placeholder="1000">
        </div>
        <div>
          <label>Qty Defective *</label>
          <input id="dDefective" type="number" class="form-input" placeholder="5">
        </div>
      </div>
      <label>Notes</label>
      <textarea id="dNotes" class="form-input" rows="2" placeholder="Observations, conditions..."></textarea>
      <button class="btn-primary" onclick="saveDefect()"><i class="fas fa-save"></i> Save Record</button>
    </div>
  </div>
</div>

<style>
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal-box{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg-surface)}
.modal-header h3{margin:0;font-size:.95rem}
.modal-body{padding:1.25rem;display:flex;flex-direction:column;gap:.75rem}
.modal-body label{font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.2rem}
.modal-body .form-input{width:100%;box-sizing:border-box}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead tr{border-bottom:1px solid var(--border)}
th{padding:.5rem .875rem;text-align:left;color:var(--text-muted);font-family:var(--font-mono);font-size:.7rem;font-weight:500}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--bg-raised)}
td{padding:.5rem .875rem}
</style>
<script>
const DEMO_DEFECTS = [
  {id:1,defect_date:'2025-02-15',machine_code:'M-01',machine_name:'CNC Press',shift:'morning',defect_code:'D-101',defect_description:'Surface Scratch',quantity_produced:1200,quantity_defective:8,notes:'Tool wear suspected'},
  {id:2,defect_date:'2025-02-15',machine_code:'M-03',machine_name:'Welding Unit',shift:'night',defect_code:'D-202',defect_description:'Dimensional Error',quantity_produced:800,quantity_defective:24,notes:'Calibration drift'},
  {id:3,defect_date:'2025-02-14',machine_code:'M-02',machine_name:'Assembly Station',shift:'afternoon',defect_code:'D-303',defect_description:'Assembly Defect',quantity_produced:950,quantity_defective:6,notes:''},
  {id:4,defect_date:'2025-02-14',machine_code:'M-04',machine_name:'Paint Line',shift:'morning',defect_code:'D-404',defect_description:'Paint Defect',quantity_produced:1100,quantity_defective:15,notes:'Paint viscosity issue'},
  {id:5,defect_date:'2025-02-13',machine_code:'M-01',machine_name:'CNC Press',shift:'afternoon',defect_code:'D-101',defect_description:'Surface Scratch',quantity_produced:1050,quantity_defective:3,notes:''},
];

document.addEventListener('DOMContentLoaded', () => {
  const user = initAppShell('Defect Records');
  if (!user) return;
  document.getElementById('dDate').value = new Date().toISOString().slice(0,10);
  loadMachines();
  loadCodes();
  loadDefects();
});

async function loadMachines() {
  let data;
  try { data = await qmsApi('/api/quality/machines'); }
  catch { data = [{id:1,code:'M-01',name:'CNC Press'},{id:2,code:'M-02',name:'Assembly Station'},{id:3,code:'M-03',name:'Welding Unit'},{id:4,code:'M-04',name:'Paint Line'}]; }
  const opts = data.map(m=>`<option value="${m.id}">${m.code} — ${m.name}</option>`).join('');
  document.getElementById('filterMachine').innerHTML = '<option value="">All Machines</option>' + opts;
  document.getElementById('dMachine').innerHTML = '<option value="">Select machine...</option>' + opts;
}

async function loadCodes() {
  let data;
  try { data = await qmsApi('/api/library/codes'); }
  catch { data = [{id:1,code:'D-101',description:'Surface Scratch'},{id:2,code:'D-202',description:'Dimensional Error'},{id:3,code:'D-303',description:'Assembly Defect'},{id:4,code:'D-404',description:'Paint Defect'}]; }
  document.getElementById('dCode').innerHTML = '<option value="">Select code...</option>' + data.map(c=>`<option value="${c.id}">${c.code} — ${c.description}</option>`).join('');
}

async function loadDefects() {
  let data;
  try { data = await qmsApi('/api/quality/defects'); }
  catch { data = DEMO_DEFECTS; }

  // KPIs
  const total = data.length;
  const defective = data.reduce((s,r)=>s+parseInt(r.quantity_defective||0),0);
  const produced = data.reduce((s,r)=>s+parseInt(r.quantity_produced||0),0);
  const ppm = produced ? (defective/produced*1000000).toFixed(0) : 0;
  const fpy = produced ? (100 - defective/produced*100).toFixed(2) : 100;
  document.getElementById('kTotal').textContent = total;
  document.getElementById('kDefective').textContent = fmt(defective);
  document.getElementById('kPPM').textContent = fmt(ppm);
  document.getElementById('kFPY').textContent = fmtPct(fpy);
  document.getElementById('recordCount').textContent = `${total} records`;

  // Table
  const el = document.getElementById('defectTable');
  if (!data.length) { el.innerHTML = '<div class="empty-state">No defect records found</div>'; return; }
  el.innerHTML = `
    <table>
      <thead><tr>
        <th>DATE</th><th>MACHINE</th><th>SHIFT</th><th>CODE</th><th>DESCRIPTION</th>
        <th>PRODUCED</th><th>DEFECTIVE</th><th>PPM</th><th>NOTES</th>
      </tr></thead>
      <tbody>${data.map(r=>{
        const ppm = r.quantity_produced ? Math.round(r.quantity_defective/r.quantity_produced*1000000) : 0;
        const ppmColor = ppm > 3000 ? 'var(--red)' : ppm > 1000 ? 'var(--amber)' : 'var(--emerald)';
        return `
          <tr>
            <td style="font-family:var(--font-mono);font-size:.75rem">${r.defect_date}</td>
            <td><strong>${r.machine_code}</strong><br><span style="font-size:.7rem;color:var(--text-muted)">${r.machine_name||''}</span></td>
            <td style="color:var(--text-muted);font-size:.78rem">${r.shift||'—'}</td>
            <td><span style="font-family:var(--font-mono);font-size:.78rem;color:var(--cyan)">${r.defect_code}</span></td>
            <td style="font-size:.8rem">${r.defect_description||'—'}</td>
            <td style="font-family:var(--font-mono);text-align:right">${fmt(r.quantity_produced)}</td>
            <td style="font-family:var(--font-mono);text-align:right;color:var(--red)">${fmt(r.quantity_defective)}</td>
            <td style="font-family:var(--font-mono);text-align:right;color:${ppmColor};font-weight:600">${fmt(ppm)}</td>
            <td style="font-size:.72rem;color:var(--text-muted);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.notes||'—'}</td>
          </tr>
        `;
      }).join('')}</tbody>
    </table>
  `;
}

async function runRCA() {
  const code = document.getElementById('rcaCode').value.trim();
  if (!code) { showToast('Enter a defect code first', 'warn'); return; }
  let d;
  try { d = await qmsApi('/api/q40/rca/predict', 'POST', {defect_code: code}); }
  catch {
    d = {top_cause:'Machine calibration drift',confidence:0.42,root_causes:[
      {root_cause:'Machine calibration drift',probability:0.42,occurrence_count:23},
      {root_cause:'Material batch quality',probability:0.28,occurrence_count:15},
      {root_cause:'Operator training gap',probability:0.18,occurrence_count:10},
    ]};
  }
  const el = document.getElementById('rcaResult');
  el.innerHTML = `
    <div style="margin-bottom:.4rem"><strong style="color:var(--cyan)">${code}</strong> — Top cause: <strong>${d.top_cause}</strong> (${fmtPct((d.confidence||0)*100,0)} confidence)</div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      ${(d.root_causes||[]).slice(0,3).map(rc=>`
        <div style="background:var(--bg-raised);border:1px solid var(--border);border-radius:6px;padding:.3rem .6rem;font-size:.72rem">
          <div style="font-weight:600">${rc.root_cause}</div>
          <div style="color:var(--text-muted)">${fmtPct((rc.probability||0)*100,0)} — ${rc.occurrence_count} cases</div>
        </div>
      `).join('')}
    </div>
  `;
}

function openAddDefect() { document.getElementById('defectModal').style.display = 'flex'; }
function closeModal() { document.getElementById('defectModal').style.display = 'none'; }

async function saveDefect() {
  const payload = {
    defect_date: document.getElementById('dDate').value,
    machine_id: document.getElementById('dMachine').value,
    defect_code_id: document.getElementById('dCode').value,
    shift: document.getElementById('dShift').value,
    quantity_produced: parseInt(document.getElementById('dProduced').value),
    quantity_defective: parseInt(document.getElementById('dDefective').value),
    notes: document.getElementById('dNotes').value,
  };
  if (!payload.defect_date || !payload.quantity_produced) { showToast('Date and quantity are required', 'error'); return; }
  try {
    await qmsApi('/api/quality/defects', 'POST', payload);
    showToast('Defect record saved!', 'success');
    closeModal();
    loadDefects();
  } catch { showToast('Saved (demo mode)', 'info'); closeModal(); }
}
</script>
<script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/guards.js"></script>
<script src="js/app.js"></script>
</body>
</html>
