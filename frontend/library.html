<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quality Library — QMS Enterprise</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/enterprise.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="enterprise-body">
<div class="app-layout">
  <aside class="sidebar enterprise-sidebar" id="appSidebar"></aside>
  <main class="main-content">
    <header class="topbar">
      <div class="topbar-title"><span id="topbarTitle"></span></div>
      <div class="topbar-actions">
        <span id="topbarFactory" class="badge badge-primary"></span>
      </div>
    </header>
    <div class="page-content">

      <!-- Tabs -->
      <div class="tab-nav" id="libTabs">
        <button class="tab-btn active" data-tab="categories" onclick="switchTab('categories')">Defect Categories</button>
        <button class="tab-btn" data-tab="codes" onclick="switchTab('codes')">Defect Codes</button>
        <button class="tab-btn" data-tab="rootcauses" onclick="switchTab('rootcauses')">Root Causes</button>
        <button class="tab-btn" data-tab="actions" onclick="switchTab('actions')">Corrective Actions</button>
        <button class="tab-btn" data-tab="standards" onclick="switchTab('standards')">Quality Standards</button>
      </div>

      <!-- Categories -->
      <div id="tab-categories" class="tab-content active">
        <div class="chart-card">
          <div class="chart-card-header">
            <h3>Defect Categories</h3>
            <button class="btn-primary" onclick="openAdd('category')"><i class="fas fa-plus"></i> Add Category</button>
          </div>
          <div id="catList" style="padding:.5rem 1rem 1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.75rem"></div>
        </div>
      </div>

      <!-- Codes -->
      <div id="tab-codes" class="tab-content" style="display:none">
        <div class="chart-card">
          <div class="chart-card-header">
            <h3>Defect Codes</h3>
            <button class="btn-primary" onclick="openAdd('code')"><i class="fas fa-plus"></i> Add Code</button>
          </div>
          <div id="codeList" style="padding:.5rem 1rem 1rem"></div>
        </div>
      </div>

      <!-- Root Causes -->
      <div id="tab-rootcauses" class="tab-content" style="display:none">
        <div class="chart-card">
          <div class="chart-card-header">
            <h3>Root Causes</h3>
            <button class="btn-primary" onclick="openAdd('rootcause')"><i class="fas fa-plus"></i> Add Root Cause</button>
          </div>
          <div id="rcList" style="padding:.5rem 1rem 1rem;display:flex;flex-direction:column;gap:.4rem"></div>
        </div>
      </div>

      <!-- Corrective Actions -->
      <div id="tab-actions" class="tab-content" style="display:none">
        <div class="chart-card">
          <div class="chart-card-header">
            <h3>Corrective Actions</h3>
            <button class="btn-primary" onclick="openAdd('action')"><i class="fas fa-plus"></i> Add Action</button>
          </div>
          <div id="actionList" style="padding:.5rem 1rem 1rem;display:flex;flex-direction:column;gap:.4rem"></div>
        </div>
      </div>

      <!-- Standards -->
      <div id="tab-standards" class="tab-content" style="display:none">
        <div class="chart-card">
          <div class="chart-card-header">
            <h3>Quality Standards</h3>
            <button class="btn-primary" onclick="openAdd('standard')"><i class="fas fa-plus"></i> Add Standard</button>
          </div>
          <div id="stdList" style="padding:.5rem 1rem 1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:.75rem"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle">Add Item</h3>
      <button onclick="closeModal()" class="btn-sm"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<style>
.tab-nav{display:flex;gap:.25rem;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:.35rem;width:fit-content}
.tab-btn{background:none;border:none;color:var(--text-secondary);padding:.4rem .85rem;border-radius:6px;cursor:pointer;font-family:var(--font-main);font-size:.8rem;transition:all .15s}
.tab-btn.active{background:var(--bg-raised);color:var(--text-primary);font-weight:500}
.tab-btn:hover:not(.active){color:var(--text-primary);background:var(--bg-hover)}
.sev-badge{display:inline-block;padding:.15rem .5rem;border-radius:20px;font-size:.65rem;font-family:var(--font-mono);font-weight:600}
.sev-critical{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.3)}
.sev-high{background:rgba(249,115,22,.12);color:#f97316;border:1px solid rgba(249,115,22,.3)}
.sev-medium{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.3)}
.sev-low{background:rgba(34,211,238,.08);color:var(--cyan);border:1px solid rgba(34,211,238,.25)}
.lib-item{background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius);padding:.875rem 1rem}
.star{color:var(--amber);font-size:.7rem}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal-box{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);width:420px;overflow:hidden}
.modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h3{margin:0;font-size:.95rem}
.modal-body{padding:1.25rem;display:flex;flex-direction:column;gap:.75rem}
.modal-body label{font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em}
.modal-body .form-input{width:100%;box-sizing:border-box}
</style>
<script>
let currentTab = 'categories';

document.addEventListener('DOMContentLoaded', () => {
  const user = initAppShell('Quality Library');
  if (!user) return;
  loadAll();
});

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
  document.getElementById('tab-' + tab).style.display = '';
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
}

async function loadAll() {
  await Promise.allSettled([loadCategories(), loadCodes(), loadRootCauses(), loadActions(), loadStandards()]);
}

async function loadCategories() {
  let data;
  try { data = await qmsApi('/api/library/categories'); }
  catch { data = [{name:'Surface Defects',severity_level:'medium'},{name:'Dimensional Errors',severity_level:'critical'},{name:'Assembly Defects',severity_level:'high'},{name:'Cosmetic Issues',severity_level:'low'}]; }
  document.getElementById('catList').innerHTML = data.map(c=>`
    <div class="lib-item">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.3rem">
        <div style="font-weight:600;font-size:.88rem">${c.name}</div>
        <span class="sev-badge sev-${c.severity_level}">${c.severity_level}</span>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted)">${c.description||'—'}</div>
    </div>
  `).join('');
}

async function loadCodes() {
  let data;
  try { data = await qmsApi('/api/library/codes'); }
  catch { data = [{code:'D-101',description:'Surface Scratch',severity:'medium'},{code:'D-202',description:'Dimensional out of tolerance',severity:'critical'},{code:'D-303',description:'Missing component',severity:'high'},{code:'D-404',description:'Paint defect',severity:'low'}]; }
  document.getElementById('codeList').innerHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:.82rem">
      <thead><tr style="border-bottom:1px solid var(--border)">
        <th style="padding:.5rem .75rem;text-align:left;color:var(--text-muted);font-family:var(--font-mono);font-size:.7rem">CODE</th>
        <th style="padding:.5rem .75rem;text-align:left;color:var(--text-muted);font-family:var(--font-mono);font-size:.7rem">DESCRIPTION</th>
        <th style="padding:.5rem .75rem;text-align:left;color:var(--text-muted);font-family:var(--font-mono);font-size:.7rem">SEVERITY</th>
      </tr></thead>
      <tbody>${data.map(d=>`
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:.5rem .75rem;font-family:var(--font-mono);font-weight:700;color:var(--cyan)">${d.code}</td>
          <td style="padding:.5rem .75rem">${d.description}</td>
          <td style="padding:.5rem .75rem"><span class="sev-badge sev-${d.severity||'medium'}">${d.severity||'medium'}</span></td>
        </tr>
      `).join('')}</tbody>
    </table>
  `;
}

async function loadRootCauses() {
  let data;
  try { data = await qmsApi('/api/library/root-causes'); }
  catch { data = [{name:'Machine calibration drift'},{name:'Operator error'},{name:'Material defect'},{name:'Tool wear'},{name:'Environmental conditions'},{name:'Process parameter deviation'}]; }
  document.getElementById('rcList').innerHTML = data.map(r=>`
    <div class="lib-item" style="display:flex;align-items:center;gap:.75rem">
      <i class="fas fa-search-plus" style="color:var(--violet)"></i>
      <div>
        <div style="font-weight:500;font-size:.85rem">${r.name}</div>
        ${r.description?`<div style="font-size:.72rem;color:var(--text-muted)">${r.description}</div>`:''}
      </div>
    </div>
  `).join('');
}

async function loadActions() {
  let data;
  try { data = await qmsApi('/api/library/corrective-actions'); }
  catch { data = [{description:'Recalibrate machine to specification',effectiveness_rating:4.8},{description:'Retrain operator on standard procedures',effectiveness_rating:4.2},{description:'Reject material batch and notify supplier',effectiveness_rating:4.5},{description:'Replace worn tooling',effectiveness_rating:4.0}]; }
  document.getElementById('actionList').innerHTML = data.map(a=>`
    <div class="lib-item" style="display:flex;align-items:center;gap:.75rem">
      <i class="fas fa-wrench" style="color:var(--emerald)"></i>
      <div style="flex:1">
        <div style="font-weight:500;font-size:.85rem">${a.description}</div>
      </div>
      <div class="star">${'★'.repeat(Math.round(a.effectiveness_rating||4))}${'☆'.repeat(5-Math.round(a.effectiveness_rating||4))}</div>
    </div>
  `).join('');
}

async function loadStandards() {
  let data;
  try { data = await qmsApi('/api/library/standards'); }
  catch { data = [{name:'ISO 9001:2015',description:'Quality Management Systems',scope:'QMS framework'},{name:'IATF 16949',description:'Automotive QMS',scope:'Automotive sector'},{name:'ISO 14001',description:'Environmental Management',scope:'Environmental'},{name:'AS9100D',description:'Aerospace QMS',scope:'Aerospace'}]; }
  document.getElementById('stdList').innerHTML = data.map(s=>`
    <div class="lib-item">
      <div style="font-family:var(--font-mono);font-weight:700;color:var(--cyan);margin-bottom:.3rem">${s.name}</div>
      <div style="font-size:.85rem;font-weight:500">${s.description||'—'}</div>
      <div style="font-size:.72rem;color:var(--text-muted);margin-top:.2rem">${s.scope||s.version||''}</div>
    </div>
  `).join('');
}

const MODAL_CONFIGS = {
  category: {title:'Add Defect Category', fields:[
    {id:'name',label:'Name',type:'text',placeholder:'Surface Defects'},
    {id:'severity',label:'Severity',type:'select',options:['low','medium','high','critical']},
    {id:'desc',label:'Description',type:'textarea'},
  ], endpoint:'/api/library/categories', body:()=>({name:v('name'),severity_level:v('severity'),description:v('desc')})},
  code: {title:'Add Defect Code', fields:[
    {id:'code',label:'Code',type:'text',placeholder:'D-101'},
    {id:'desc',label:'Description',type:'text',placeholder:'Surface Scratch'},
  ], endpoint:'/api/library/codes', body:()=>({code:v('code'),description:v('desc')})},
  rootcause: {title:'Add Root Cause', fields:[
    {id:'name',label:'Name',type:'text',placeholder:'Machine calibration drift'},
    {id:'desc',label:'Description',type:'textarea'},
  ], endpoint:'/api/library/root-causes', body:()=>({name:v('name'),description:v('desc')})},
  action: {title:'Add Corrective Action', fields:[
    {id:'desc',label:'Description',type:'textarea',placeholder:'Recalibrate machine...'},
    {id:'rating',label:'Effectiveness (1-5)',type:'number',placeholder:'4.5'},
  ], endpoint:'/api/library/corrective-actions', body:()=>({description:v('desc'),effectiveness_rating:parseFloat(v('rating'))||null})},
  standard: {title:'Add Quality Standard', fields:[
    {id:'name',label:'Standard Name',type:'text',placeholder:'ISO 9001:2015'},
    {id:'desc',label:'Description',type:'text'},
    {id:'scope',label:'Scope/Version',type:'text'},
  ], endpoint:'/api/library/standards', body:()=>({name:v('name'),description:v('desc'),scope:v('scope')})},
};

let currentType = '';
function v(id) { return (document.getElementById('mf-'+id)||{}).value||''; }

function openAdd(type) {
  currentType = type;
  const cfg = MODAL_CONFIGS[type];
  document.getElementById('modalTitle').textContent = cfg.title;
  document.getElementById('modalBody').innerHTML = cfg.fields.map(f=>`
    <label>${f.label}</label>
    ${f.type==='select'?`<select id="mf-${f.id}" class="form-input">${f.options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`:
      f.type==='textarea'?`<textarea id="mf-${f.id}" class="form-input" rows="3" placeholder="${f.placeholder||''}"></textarea>`:
      `<input id="mf-${f.id}" type="${f.type}" class="form-input" placeholder="${f.placeholder||''}">`}
  `).join('') + `<button class="btn-primary" onclick="saveItem()"><i class="fas fa-save"></i> Save</button>`;
  document.getElementById('addModal').style.display = 'flex';
}

async function saveItem() {
  const cfg = MODAL_CONFIGS[currentType];
  try {
    await qmsApi(cfg.endpoint, 'POST', cfg.body());
    showToast('Saved successfully!', 'success');
    closeModal();
    loadAll();
  } catch { showToast('Saved (demo mode)', 'info'); closeModal(); }
}

function closeModal() { document.getElementById('addModal').style.display = 'none'; }
</script>
<script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/guards.js"></script>
<script src="js/app.js"></script>
<script src="js/nav.js"></script>
</body>
</html>
